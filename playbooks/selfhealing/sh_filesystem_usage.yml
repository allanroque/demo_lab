---
- name: Automate File and Log Management
  hosts: all
  become: true  # Necessário para permissões de root para algumas tarefas
  tasks:
    - name: List top 5 largest files in specified directories
      ansible.builtin.shell:
        cmd: find {{ item }} -type f -exec du -h {} + 2>/dev/null | sort -rh | head -n 5
      loop:
        - "/"
        - "/opt"
        - "/var"
        - "/var/log"
      register: largest_files
      changed_when: false

    - name: Display largest files in a clean list format
      ansible.builtin.debug:
        msg: |
          Largest files in {{ item.item }}:
          {% for line in item.stdout_lines %}
          - {{ line.split("\t")[1] }} (Size: {{ line.split("\t")[0] }})
          {% endfor %}
      loop: "{{ largest_files.results }}"
      when: item.stdout_lines is defined

    - name: Force log rotation
      ansible.builtin.command:
        cmd: logrotate -f /etc/logrotate.conf
      ignore_errors: true  # Continue mesmo se logrotate falhar

    - name: Cleanup temporary and specific log files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/var/log/app.log"